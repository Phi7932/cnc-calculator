<script>
    // Hàm này sẽ thay thế hàm calculate() cũ của bạn
    async function calculate() {
        const status = document.getElementById('statusMessage');
        status.textContent = "Processing on Secure Server...";
        status.className = "status-message success";

        // Thu thập dữ liệu từ giao diện
        const payload = {
            mode: selectedMode, // Biến này bạn đã có trong UI
            machine: selectedMachine,
            params: {
                pcd: parseFloat(document.getElementById('pcd')?.value || 0),
                holes: parseInt(document.getElementById('holes')?.value || 0),
                rotation: parseFloat(document.getElementById('rotation')?.value || 0),
                depth: parseFloat(document.getElementById('depth')?.value || 0),
                hexFlat: parseFloat(document.getElementById('hexFlat')?.value || 0)
                // ... Thêm các tham số khác tương ứng các ô input của bạn
            }
        };

        try {
            // GỬI LÊN VERCEL SERVER ĐỂ TÍNH TOÁN
            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            // Hiển thị G-Code trả về
            document.getElementById('gcodeOutput').textContent = result.gcode;

            // Vẽ lên Canvas (Sử dụng dữ liệu coords/path server gửi về)
            if (selectedMode === 'drilling') {
                drawDrillingVisualization(result.radius, result.coords);
            } else {
                drawMillingVisualization(result.path);
            }

            status.textContent = "Calculation Complete!";
        } catch (error) {
            status.textContent = "Server Error!";
            status.className = "status-message error";
        }
    }
</script>
