<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC G-Code Generator - Drilling & Hexagon Milling</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --secondary: #0088ff;
            --bg-dark: #0a0e1a;
            --bg-darker: #050810;
            --bg-card: #151b2e;
            --text-primary: #e0e6f0;
            --text-secondary: #8892a6;
            --border: #1e2842;
            --warning: #ffaa00;
            --error: #ff3366;
            --grid: rgba(0, 255, 136, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: var(--bg-darker);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, var(--grid) 0px, transparent 1px, transparent 40px),
                repeating-linear-gradient(90deg, var(--grid) 0px, transparent 1px, transparent 40px);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 15px 30px;
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            animation: slideDown 0.8s ease-out;
            position: relative;
            flex-shrink: 0;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .subtitle {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: #b8c5e0;
            letter-spacing: 1.5px;
            font-style: italic;
            font-weight: 400;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .mode-btn {
            padding: 15px 40px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-btn img {
            width: 28px;
            height: 28px;
            filter: brightness(0.7) contrast(1.2);
            transition: filter 0.3s ease;
        }

        .mode-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .mode-btn:hover img {
            filter: brightness(1.3) contrast(1.2);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 136, 255, 0.2));
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .mode-btn.active img {
            filter: brightness(1.5) drop-shadow(0 0 8px rgba(0, 255, 136, 0.6));
        }

        .main-grid {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 20px;
            flex: 1;
            min-height: 0;
            animation: fadeIn 1s ease-out 0.3s backwards;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .card-title::before {
            content: '‚ñ∏';
            font-size: 1.3rem;
        }

        .card-title::before {
            content: '‚ñ∏';
            font-size: 1.5rem;
        }

        .input-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        /* Two column layout for inputs */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        input[type="number"]:hover {
            border-color: var(--secondary);
        }

        .cycle-selector, .milling-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .cycle-btn, .milling-type-btn {
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .cycle-btn:hover, .milling-type-btn:hover {
            border-color: var(--secondary);
            transform: translateY(-1px);
        }

        .cycle-btn.active, .milling-type-btn.active {
            background: rgba(0, 255, 136, 0.15);
            border-color: var(--primary);
            color: var(--primary);
        }

        .machine-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .machine-btn {
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .machine-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
            opacity: 0.2;
        }

        .machine-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .machine-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .machine-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 136, 255, 0.2));
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .machine-btn.active::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--bg-darker);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.05rem;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
            margin-top: auto;
            flex-shrink: 0;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 255, 136, 0.5);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .gcode-output {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            color: var(--primary);
            white-space: pre;
            overflow-x: auto;
            overflow-y: auto;
            line-height: 1.6;
            flex: 1;
            min-height: 0;
        }

        .gcode-output::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .gcode-output::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        .gcode-output::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .gcode-output::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .visualization {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            width: auto !important;
            height: auto !important;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
        }

        .status-message.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--primary);
            color: var(--primary);
            opacity: 1;
        }

        .status-message.error {
            background: rgba(255, 51, 102, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
            opacity: 1;
        }

        footer {
            text-align: right;
            padding: 8px 15px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            position: absolute;
            bottom: 5px;
            right: 30px;
            z-index: 10;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.5rem;
            }

            .subtitle {
                position: static;
                transform: none;
                margin-top: 10px;
                text-align: center;
            }
        }

        .hidden {
            display: none;
        }

        /* CHECKER MODE STYLES - ADDED */
        .checker-upload-area {
            background: var(--bg-dark);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .checker-upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.05);
        }

        .checker-upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .checker-upload-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .checker-filename {
            color: var(--primary);
            font-weight: 700;
            margin-top: 10px;
            min-height: 20px;
            font-size: 0.85rem;
        }

        .checker-textarea {
            width: 100%;
            height: 300px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.75rem;
            color: var(--primary);
            resize: vertical;
            line-height: 1.5;
        }

        .checker-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .checker-textarea::-webkit-scrollbar {
            width: 8px;
        }

        .checker-textarea::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        .checker-textarea::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .checker-textarea::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .checker-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .checker-btn {
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .checker-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .checker-btn.check-btn {
            background: rgba(0, 136, 255, 0.15);
            border-color: var(--secondary);
        }

        .checker-btn.fix-btn {
            background: rgba(255, 170, 0, 0.15);
            border-color: var(--warning);
        }

        .checker-btn.save-btn {
            background: rgba(0, 255, 136, 0.15);
            border-color: var(--primary);
        }

        .checker-btn.clear-btn {
            background: rgba(255, 51, 102, 0.15);
            border-color: var(--error);
        }

        .checker-result {
            height: 400px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.75rem;
            margin-bottom: 15px;
        }

        .checker-result::-webkit-scrollbar {
            width: 8px;
        }

        .checker-result::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        .checker-result::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .checker-result::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .checker-error-item {
            background: rgba(255, 51, 102, 0.1);
            border-left: 3px solid var(--error);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checker-error-item:hover {
            background: rgba(255, 51, 102, 0.2);
            border-left-width: 5px;
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(255, 51, 102, 0.3);
        }

        .checker-error-line {
            color: var(--error);
            font-weight: bold;
            font-size: 0.8rem;
        }

        .checker-error-code {
            color: var(--text-primary);
            background: var(--bg-darker);
            padding: 6px;
            border-radius: 4px;
            margin: 6px 0;
        }

        .checker-error-msg {
            color: var(--warning);
            font-size: 0.7rem;
            font-style: italic;
        }

        .checker-success {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            color: var(--primary);
            font-weight: 700;
        }

        .checker-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .checker-stat {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .checker-stat-num {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
        }

        .checker-stat-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .checker-info {
            background: rgba(0, 136, 255, 0.1);
            border-left: 3px solid var(--secondary);
            padding: 15px;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.8;
            margin-top: 15px;
        }

        .checker-info strong {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .checker-info code {
            font-size: 0.9rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--bg-darker);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CNC G-CODE GENERATOR</h1>
            <p class="subtitle">Designed by Phi7932</p>
        </header>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="drilling">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAEaklEQVR4nM3Yy6vVVRQH8M855169XjOuGpkgGkQQZjRIUsF8UKGDmkQPdVYDwbJJkx5/QARBEEUNIi4ERdCkYUGCEGZFzZwIZShKEkL5yMx7zzkN9tr99r2dt5euC36c89t77bW+e+211l7rV8MxbEPLzUV1HK+hvdhIetEYZuP3DXyLhsWzZh1NbMUrgc2MZMXtiwSqE22XMM2M4SqWYz9+CobmIgFrxO/+wHC1hnfxQkz8rj+4mnQUbYO7Qj3WtfT3+QZWxv/3YBk+CmDtm+RpBqZltQL5JmxQmbmTFVp4EK/hEp7HlbDOfMvksVvCErfidXxfyOpETZzGiVJQvQtzJ3o4FP/WYzMlNYK3HWsHpTpqYyqzZj/ppaiJFfFek3zlD70tOFXIXRFysqxu9K9/jxWDgzh8c57gGZGretBMl/UDZYqx/iwd1zQxia+l3dYkoNmKteDLc5OxZmh9owC8KB3RJO4bYe1Q1MvnuvHXcQB3YL0UyTN4S/JHkt+9hHEpgs/gPD4xWC5cMLo/lP1pbiaox1g7eEamUY4Ylko+lTN+A09J6QRuV6WglaGngb//L4CzATBH/jg+ncfTKn7LABqKRgXYia6p8mnDcMm/K90owGyV69ItcR5/Scf6IybcYEAsyC6DTuKUBPBp1eaHzRRzaBgLNnQvsZpSoXEIh7FGd8vlK3XBb5IssLR6ts44vlJF9bXgW9IB3FDtxDBHvBPrQsH8KmY8wF2SEvYeyS+pLJl7nXUha0EoA3k8FJ3Bxhir4aEYn8H7uDvmpqRWoh082dIbQ0Y7ZJY6RqLsLw9IhWkbZ3FvzO+KsatYXazbKSXldvCINWdj7ErIHLYW7QoS9qpy3bkAtHUewHvwAS6rWohtMXcu3q+FrFL2gtEW1dFtwGaVRT4LYGVf0Q6eDcVGtgyjsN8Osu/chmnJxzZJfetpqV0llV5PSv3HKbwZYPLc6VizKWRMh8xSx0iU09ABlWUOFYJ3xNgsfsHLUjRP6Rwkhwo5B+bpGImyE0/hSCF8X8zvUvnVxmLd2gLgrhjbV6w/EjL79UHqqsu905PnLuIJHPXfvoQqcEh38oeqJJ0B5HVHQ1auzPvpH5pWFYpzHrwsHdnnKivlynlHAXKVIWkMd0nO26/qyPfnrPSJ5DvVDifwccF7UorcCVX7ucXc4nUQfSfggtE+T6xXpZmcUn7AM7hTldg3B29rBB0XxqQk2gyBZQ/biepSKlkiVSy5qm7hOcmKs6qSvxU8a8Ii10NPv4JhPPSsLj9gvogvdK448tg6fKNqlHIF3ZZcJTfxr4aSuhTh+ZhbeES68nrp2St9PJql6hd299kVKTHnozsYY9OqIzkcT36fDp6Dqhtnuf60O/hnyyT5qPQFqtcn4KWS5SbxthQMz0p5bw/eKXi/jLmdwZut/pju3V3+BDznOhwlQHJQ/Bpgl+N4MX88xiaDp1wz7OOYqjUc5MnKWmGlidjoWvwcz9oYmwieHCztIfS0cOwfHiiph7dYs0QAAAAASUVORK5CYII=" alt="Drilling">
                DRILLING
            </button>
            <button class="mode-btn" data-mode="milling">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAGOElEQVR4nO2Y329cRxXHP2fm7q5/dHcdO6ntpCUJDSmuoE0AtQ2KkKJIiAoeWl4QQsALgjcqgYSE+gfQJOKBtBKI8liBKiR+CAlQGqFCJEqQQqCJnWTjxo6dxNmNvev95d29884cHu46iduIJGtTKtTvarSzD/fezz3nzHfOrKgq72eZ/zXA3fQB4Hr1AeB69RPg7kcn9OhLL+vhI0f++xagqvc1jh59Sefn5/XKlXm9du2qnp08q1/68lf0fu9zr0Pu1Qc/+7ln9IUXvs+uXY9wsVBgqVwhCjtsG9/GxGMTnDr1Dw4d+SF/On5MNjKAdwV8fM9e/fbzz/OFzz9DqXidQuEi3nmssYhR4jgmncmwfccOsg9kee21X/Lqqz/n3NSZDQH9j4A/OHREv/61rxK220xOTdJoNAhSAQjd8AMIzjniOCaXy/HYxAQiwo9/8lMOH35x3ZB3BPzOd7+n3/zWN8jlsly4cI7SjRtYYzAmQNXD6jUqyVxAAOcdDsfY+FZ2bt/B0R+9zB/++DpTZ//VM+gawKf3fVoPHX6RPXueYHp6mvnLl4ljj7U2KVrvExIRxBjoFnLy7THGIMZQq9VpNposLi5SLi8xMzvHb3/z654g1wBemrmkYRRybmoKF7kuGF0Ij4oiIthUBg0ySZqjNuo9RgxhGFKuLNHpdBARjDF0wg5RGDL99gw/e+WV+4YMbv9Rr9e5evUK3ilBKoXzMSoeFUAVAYwNiFP97N79KC6OuFQoYHyLan2ZeqNG7GJMYADFaUw6k8Zai+kxyWsA1XusMSAer4qioCAkURax2MwAnXSebH4I72JaqQHC5SXqy1XAYzBo3L1OBJVkbmxwp+ffVWt2EpHua3oBbxAVko/BSACpPnRgmP17Psp4vp+xTVk+9fEJ4r4h0v1ZjEmBkgzpTkTBgGxEBEWEJGiKJB6Ckry9zQwig8MEDwyxOT9AX5Bcum1kiOzoQ7RSAbJcIlypo3GEiKII1lpcGNFrY/yuuOvNECQOYmyABAM0gxxPfuQRPrQ5h4GbD+wLLM/t+xhn5rbwl7+fJu1AXA1chIjQbDZprjSx1q4fMAhSSd2oJHAiOAl46OHtjI+PM5ztIx0Ybg9GYA0pEXaNjZD7zNNMXTjP7PlJrMYsLt6g0WggIiwsLPQEuKYG56/M471PCkYUMYKxljCOiJzr1ujtxXRr7tWhohhribyjWCpRq9UwxuCcp1ar9QS4JoLXry+waWgTBjAYXOxYqS9xY7HCmZkFDjy1lw+PDpMyYI0FlMh5Yq9MX13kjZOn8eVrVItX6LSaCAbvEoM3prfW8x0pDkAFMUIUR1QqZTphSCrdRyYwnPznW0xtHuPZJye6q1JoRzG/+usZWsV5OgsXqS6V0DgG8YmRG4t6veUQ6wH03mOtoRPGLFcrRHGEsULsQnyzholCUKWwMMrDw1lAuVyqUJq9wI2Z88SdBnh/236d1DMeVhfe/WpN3HPZHM2VBqVikU67k9zTKeI9xCHaWcFVihx78xSLzZDZUoVf/O4YS5cLxCt1iBwaOfAePKhfhYMeXWZtBOfm5kin04gYjHSbACOA4tUjLiJqVUmr5+3pAuWlMq3iLNJu4F3ctZ5uOiXZgYwVWu2QOI7XD/jWmbNsGRkhl8+Ry2dR3227RZL1qoIoVK8v8PsLBVDF+pA4jm5b0IKqYiSxo2ZzhVq1hrG9LZJ39YPPPvdFHRt9kP7+Pnbu3EkmnSEKI1YdplavUyqVkNXIuiSHesvfMcbQbreoVqs0mk2KpUVO/u3N9bdbq3pq337dtnWUTUN5HhwdZXzrGJ1Om1KxRBh2MMbe3HNXGwrVxD6di6ksL7PSWqHRXGH28lUK5yY3pmF9p57Y+0ndOj7K2NgomUya/r5+jBi8d90tkaQNM4KIodVus7y8TK1WZ2ZmjqnJ9Z9L7ulUd+DAQR0ZHmJgcJDBwQH6+jJ0+ykMQrvdoVqtUm80KJernDjx5w072d3zsRPgwMGDOjKcJ5fLk8tmk0XQaFKr1yhXKhx//fiGHjnvGxDg8T2f0PHRLeTzOVBPrdGgWFrk9KlTGw7XE+Cq9u3fr0FgOfHGxqXzTuoZ8L3S/+e/W++lPgBcr973gP8GeO6oE8gOvMUAAAAASUVORK5CYII=" alt="Hexagon">
                HEXAGON MILLING
            </button>
            <button class="mode-btn" data-mode="circular">
                <span style="font-size: 1.8rem;">‚≠ï</span>
                CIRCULAR MILLING
            </button>
            <button class="mode-btn" data-mode="checker">
                <span style="font-size: 1.8rem;">‚úì</span>
                G-CODE CHECKER
            </button>
        </div>

        <div class="main-grid">
            <!-- Left Panel - Input Parameters -->
            <div class="card">
                <h2 class="card-title">Input Data</h2>

                <!-- DRILLING MODE -->
                <div id="drillingInputs">
                    <div class="input-row">
                        <div class="input-group">
                            <label for="pcd">PCD (mm)</label>
                            <input type="number" id="pcd" value="100" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="holes">Number of Holes</label>
                            <input type="number" id="holes" value="6" min="3" step="1">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="depth">Depth Z (mm)</label>
                            <input type="number" id="depth" value="-10" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="height">Retract R (mm)</label>
                            <input type="number" id="height" value="2" step="0.001">
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="drillingRotation">Start Angle (¬∞)</label>
                        <input type="number" id="drillingRotation" value="0" step="1" min="0" max="360">
                    </div>

                    <div class="input-group">
                        <label>Drilling Cycle</label>
                        <div class="cycle-selector">
                            <button class="cycle-btn active" data-cycle="G81">G81</button>
                            <button class="cycle-btn" data-cycle="G83">G83</button>
                        </div>
                    </div>

                    <div class="input-group" id="qValueGroup" style="display: none;">
                        <label for="qValue">Q Value (mm)</label>
                        <input type="number" id="qValue" value="2" step="0.001">
                    </div>
                </div>

                <!-- MILLING MODE -->
                <div id="millingInputs" class="hidden">
                    <div class="input-row">
                        <div class="input-group">
                            <label for="hexHeight">Hex Height H (mm)</label>
                            <input type="number" id="hexHeight" value="10" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="toolDiameter">Tool √ò D (mm)</label>
                            <input type="number" id="toolDiameter" value="6" step="0.001" min="0.1">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="millingFinishAllowance">Finish Allowance (mm)</label>
                            <input type="number" id="millingFinishAllowance" value="0.5" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="millingLeadIn">Lead-in Distance (mm)</label>
                            <input type="number" id="millingLeadIn" value="5" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Machining Type</label>
                        <div class="milling-type-selector">
                            <button class="milling-type-btn active" data-type="inside">INSIDE</button>
                            <button class="milling-type-btn" data-type="outside">OUTSIDE</button>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="millingDepth">Cut Depth Z (mm)</label>
                            <input type="number" id="millingDepth" value="-5" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="feedRate">Feed Rate F (mm/min)</label>
                            <input type="number" id="feedRate" value="150" step="1" min="1">
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="millingRotation">Start Angle (¬∞)</label>
                        <input type="number" id="millingRotation" value="0" step="1" min="0" max="360">
                    </div>
                </div>

                <!-- CIRCULAR MODE -->
                <div id="circularInputs" class="hidden">
                    <div class="input-row">
                        <div class="input-group">
                            <label for="centerX">Center X (mm)</label>
                            <input type="number" id="centerX" value="7.55" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="centerY">Center Y (mm)</label>
                            <input type="number" id="centerY" value="0" step="0.001">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="circularPCD">PCD (mm)</label>
                            <input type="number" id="circularPCD" value="15.5" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="circularRadius">Radius (mm)</label>
                            <input type="number" id="circularRadius" value="7.75" step="0.001">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="toolDiameterCirc">Tool √ò (mm)</label>
                            <input type="number" id="toolDiameterCirc" value="8" step="0.001">
                        </div>
                        <div class="input-group">
                            <label for="finishAllowance">Finish Allowance (mm)</label>
                            <input type="number" id="finishAllowance" value="0.5" step="0.001">
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="circularDepth">Depth Z (mm)</label>
                        <input type="number" id="circularDepth" value="-18.8" step="0.001">
                    </div>

                    <div class="input-group">
                        <label>Cut Type</label>
                        <div class="milling-type-selector">
                            <button class="milling-type-btn circular-cut-btn active" data-type="inside">INSIDE</button>
                            <button class="milling-type-btn circular-cut-btn" data-type="outside">OUTSIDE</button>
                        </div>
                    </div>
                </div>

                <!-- G-CODE CHECKER MODE - ADDED -->
                <div id="checkerInputs" class="hidden">
                    <div class="checker-upload-area" onclick="document.getElementById('checkerFileInput').click()">
                        <div class="checker-upload-icon">üìÅ</div>
                        <div class="checker-upload-text">Click to select G-Code file</div>
                        <div class="checker-upload-text" style="font-size: 0.75rem;">.tap .nc .gcode .txt</div>
                        <div class="checker-filename" id="checkerFilename"></div>
                    </div>
                    <input type="file" id="checkerFileInput" accept=".tap,.nc,.gcode,.txt" style="display: none;">

                    <div style="position: relative; height: 300px; margin-bottom: 15px;">
                        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 50px; background: var(--bg-darker); border: 1px solid var(--border); border-right: 2px solid var(--primary); border-radius: 8px 0 0 8px; overflow: hidden; font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); padding: 15px 8px 15px 5px; line-height: 1.5; text-align: right; user-select: none; white-space: pre;" id="lineNumbers">1</div>
                        <textarea class="checker-textarea" id="checkerTextarea" placeholder="Or paste G-Code here...

Example:
G91G28Z0
G0G17G40G49G80G90
M6T9(D4)
G0G90G54X0Y0
M3S5000
G43H09Z30.
G1 X10 Y20 F300
G2 X5.5 Y-3. I1. J-2." style="position: absolute; left: 50px; right: 0; top: 0; bottom: 0; width: calc(100% - 50px); height: 100%; margin: 0; border-radius: 0 8px 8px 0;"></textarea>
                    </div>

                    <div class="checker-buttons">
                        <button class="checker-btn check-btn" onclick="checkGCodeFunc()">üîç CHECK</button>
                        <button class="checker-btn fix-btn" onclick="fixGCodeFunc()">üîß AUTO FIX</button>
                        <button class="checker-btn save-btn" onclick="saveGCodeFunc()">üíæ SAVE</button>
                        <button class="checker-btn clear-btn" onclick="clearCheckerFunc()">üóëÔ∏è CLEAR</button>
                    </div>
                </div>

                <!-- Machine Type and Generate Button - Hidden in checker mode -->
                <div id="machineAndGenerateSection">
                <div class="input-group">
                    <h2 class="card-title" style="margin-bottom: 12px; margin-top: 8px;">Machine Type</h2>
                    <div class="machine-selector">
                        <button class="machine-btn" data-machine="takisawa">TAKISAWA</button>
                        <button class="machine-btn active" data-machine="robodrill">ROBODRILL</button>
                        <button class="machine-btn" data-machine="f54">F54</button>
                        <button class="machine-btn" data-machine="mitsu">MITSUBISHI</button>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculate()">‚ö° GENERATE G-CODE</button>
                
                <!-- Action buttons moved here -->
                <div class="action-buttons">
                    <button class="action-btn" onclick="copyGCode()">üìã COPY CODE</button>
                    <button class="action-btn" onclick="downloadTAP()">üíæ DOWNLOAD .TAP</button>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
                </div>
            </div>

            <!-- Right Panel - Visualization & G-Code Output -->
            <div class="card">
                <h2 class="card-title">Visualization</h2>
                <div class="visualization">
                    <canvas id="visualCanvas"></canvas>
                </div>

                <h2 class="card-title" style="margin-top: 12px;">G-Code Output</h2>
                <pre class="gcode-output" id="gcodeOutput">// G-Code will appear here...</pre>
            </div>

            <!-- Right Panel for CHECKER MODE - ADDED -->
            <div class="card hidden" id="checkerRightPanel">
                <h2 class="card-title">Analysis Results</h2>
                
                <div class="checker-result" id="checkerResult">
                    <div style="text-align: center; color: var(--text-secondary); margin-top: 100px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">‚öôÔ∏è</div>
                        <div>Load G-Code file or paste code,</div>
                        <div>then click CHECK to analyze</div>
                    </div>
                </div>

                <div class="checker-stats">
                    <div class="checker-stat">
                        <div class="checker-stat-num" id="checkerTotalLines">0</div>
                        <div class="checker-stat-label">Total Lines</div>
                    </div>
                    <div class="checker-stat">
                        <div class="checker-stat-num" id="checkerErrorCount" style="color: var(--error);">0</div>
                        <div class="checker-stat-label">Errors Found</div>
                    </div>
                    <div class="checker-stat">
                        <div class="checker-stat-num" id="checkerSuccessRate">100%</div>
                        <div class="checker-stat-label">Success Rate</div>
                    </div>
                </div>

                <div class="checker-info">
                    <div style="margin-bottom: 8px;"><strong>‚ÑπÔ∏è Save Information:</strong></div>
                    <div style="margin-bottom: 6px;">
                        üìÑ File name: <code style="color: var(--primary);">[filename]_checked.tap</code>
                    </div>
                    <div style="margin-bottom: 6px;">
                        üìÅ Download to: <code style="color: var(--warning);">Downloads folder</code>
                    </div>
                    <div>
                        üí° Recommended: Move file to <code style="color: var(--warning);">G:\test\</code>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            Version 260106
        </footer>
    </div>

    <script>
        let selectedMode = 'drilling';
        let selectedCycle = 'G81';
        let selectedMachine = 'robodrill';
        let selectedMillingType = 'inside';
        let selectedCircularType = 'inside';
        let currentGCode = '';
        let coordinates = [];

        // Mode selector
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedMode = this.dataset.mode;
                
                // Toggle input panels
                document.getElementById('drillingInputs').classList.add('hidden');
                document.getElementById('millingInputs').classList.add('hidden');
                document.getElementById('circularInputs').classList.add('hidden');
                document.getElementById('checkerInputs').classList.add('hidden');
                
                // Toggle machine/generate section
                const machineSection = document.getElementById('machineAndGenerateSection');
                
                // Toggle right panels
                document.querySelectorAll('.card')[1].classList.remove('hidden'); // Original right panel
                document.getElementById('checkerRightPanel').classList.add('hidden');
                
                if (selectedMode === 'drilling') {
                    document.getElementById('drillingInputs').classList.remove('hidden');
                    machineSection.style.display = 'block';
                } else if (selectedMode === 'milling') {
                    document.getElementById('millingInputs').classList.remove('hidden');
                    machineSection.style.display = 'block';
                } else if (selectedMode === 'circular') {
                    document.getElementById('circularInputs').classList.remove('hidden');
                    machineSection.style.display = 'block';
                } else if (selectedMode === 'checker') {
                    document.getElementById('checkerInputs').classList.remove('hidden');
                    machineSection.style.display = 'none'; // Hide machine and generate buttons
                    document.querySelectorAll('.card')[1].classList.add('hidden'); // Hide original right panel
                    document.getElementById('checkerRightPanel').classList.remove('hidden');
                }
            });
        });

        // Cycle selector (drilling only)
        document.querySelectorAll('.cycle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.cycle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedCycle = this.dataset.cycle;
                
                const qValueGroup = document.getElementById('qValueGroup');
                if (selectedCycle === 'G83') {
                    qValueGroup.style.display = 'block';
                } else {
                    qValueGroup.style.display = 'none';
                }
            });
        });

        // Milling type selector (hexagon and circular)
        document.querySelectorAll('.milling-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.milling-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                if (this.classList.contains('circular-cut-btn')) {
                    selectedCircularType = this.dataset.type;
                } else {
                    selectedMillingType = this.dataset.type;
                }
            });
        });

        // Machine selector
        document.querySelectorAll('.machine-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.machine-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedMachine = this.dataset.machine;
            });
        });

        function calculate() {
            if (selectedMode === 'drilling') {
                calculateDrilling();
            } else if (selectedMode === 'milling') {
                calculateMilling();
            } else if (selectedMode === 'circular') {
                calculateCircular();
            }
        }

        function calculateDrilling() {
            const pcd = parseFloat(document.getElementById('pcd').value);
            const holes = parseInt(document.getElementById('holes').value);
            const depth = parseFloat(document.getElementById('depth').value);
            const height = parseFloat(document.getElementById('height').value);
            const qValue = parseFloat(document.getElementById('qValue').value);
            const rotation = parseFloat(document.getElementById('drillingRotation').value) || 0;

            if (isNaN(pcd) || isNaN(holes) || isNaN(depth) || isNaN(height)) {
                showStatus('Please enter all parameters!', 'error');
                return;
            }

            if (selectedCycle === 'G83' && isNaN(qValue)) {
                showStatus('Please enter Q value!', 'error');
                return;
            }

            const radius = pcd / 2;
            coordinates = [];

            // Calculate coordinates for each hole with rotation
            const rotationRad = (rotation * Math.PI) / 180;
            for (let i = 0; i < holes; i++) {
                const angle = i * (360 / holes);
                const angleRad = ((angle * Math.PI) / 180) + rotationRad;
                const x = (radius * Math.cos(angleRad)).toFixed(3);
                const y = (radius * Math.sin(angleRad)).toFixed(3);
                coordinates.push({ x, y, angle: angle.toFixed(1) });
            }

            // Generate G-Code
            currentGCode = generateDrillingGCode(selectedMachine, coordinates, depth, height, selectedCycle, qValue);
            document.getElementById('gcodeOutput').textContent = currentGCode;

            // Draw visualization
            drawDrillingVisualization(radius, coordinates);

            showStatus('G-Code generated successfully!', 'success');
        }

        function calculateMilling() {
            const H = parseFloat(document.getElementById('hexHeight').value);
            const depth = parseFloat(document.getElementById('millingDepth').value);
            const rotation = parseFloat(document.getElementById('millingRotation').value) || 0;
            const feedRate = parseFloat(document.getElementById('feedRate').value) || 150;
            const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
            const finishAllowance = parseFloat(document.getElementById('millingFinishAllowance').value) || 0;
            const leadInDistance = parseFloat(document.getElementById('millingLeadIn').value) || 5;

            if (isNaN(H) || isNaN(depth) || isNaN(toolDiameter)) {
                showStatus('Please enter all parameters!', 'error');
                return;
            }

            // Calculate hexagon vertices with tool compensation
            const toolRadius = toolDiameter / 2;
            let H_finish = H;
            let H_rough = H;
            
            // Adjust H based on milling type (inside or outside)
            if (selectedMillingType === 'inside') {
                H_finish = H - (2 * toolRadius);  // Finish pass
                H_rough = H - (2 * toolRadius) - finishAllowance;  // Rough pass (with allowance)
            } else {
                H_finish = H + (2 * toolRadius);  // Finish pass
                H_rough = H + (2 * toolRadius) + finishAllowance;  // Rough pass (with allowance)
            }
            
            const a_finish = H_finish / Math.sqrt(3);
            const a_rough = H_rough / Math.sqrt(3);
            
            // Original coordinates (before rotation) - finish pass (tool center positions)
            const originalCoords = [
                { x: 0, y: a_finish },
                { x: H_finish/2, y: a_finish/2 },
                { x: H_finish/2, y: -a_finish/2 },
                { x: 0, y: -a_finish },
                { x: -H_finish/2, y: -a_finish/2 },
                { x: -H_finish/2, y: a_finish/2 }
            ];

            // Apply rotation
            const angleRad = (rotation * Math.PI) / 180;
            coordinates = originalCoords.map((coord, idx) => {
                const x = coord.x * Math.cos(angleRad) - coord.y * Math.sin(angleRad);
                const y = coord.x * Math.sin(angleRad) + coord.y * Math.cos(angleRad);
                return {
                    x: x.toFixed(3),
                    y: y.toFixed(3),
                    label: `Vertex ${idx + 1}`
                };
            });

            // Also calculate rough pass coordinates (with finish allowance)
            const roughCoords = [
                { x: 0, y: a_rough },
                { x: H_rough/2, y: a_rough/2 },
                { x: H_rough/2, y: -a_rough/2 },
                { x: 0, y: -a_rough },
                { x: -H_rough/2, y: -a_rough/2 },
                { x: -H_rough/2, y: a_rough/2 }
            ];

            // Apply rotation to rough
            const roughRotated = roughCoords.map((coord, idx) => {
                const x = coord.x * Math.cos(angleRad) - coord.y * Math.sin(angleRad);
                const y = coord.x * Math.sin(angleRad) + coord.y * Math.cos(angleRad);
                return {
                    x: x.toFixed(3),
                    y: y.toFixed(3)
                };
            });

            // Also calculate target shape (the actual hexagon without tool compensation)
            const a_target = H / Math.sqrt(3);
            const targetCoords = [
                { x: 0, y: a_target },
                { x: H/2, y: a_target/2 },
                { x: H/2, y: -a_target/2 },
                { x: 0, y: -a_target },
                { x: -H/2, y: -a_target/2 },
                { x: -H/2, y: a_target/2 }
            ];

            // Apply rotation to target
            const targetRotated = targetCoords.map((coord, idx) => {
                const x = coord.x * Math.cos(angleRad) - coord.y * Math.sin(angleRad);
                const y = coord.x * Math.sin(angleRad) + coord.y * Math.cos(angleRad);
                return {
                    x: x.toFixed(3),
                    y: y.toFixed(3)
                };
            });

            // Generate G-Code with rough and finish passes
            currentGCode = generateMillingGCode(selectedMachine, coordinates, depth, feedRate, toolDiameter, roughRotated, selectedMillingType, leadInDistance, rotation);
            document.getElementById('gcodeOutput').textContent = currentGCode;

            // Draw visualization with target, finish and rough paths
            drawMillingVisualization(coordinates, targetRotated, roughRotated);

            showStatus('G-Code generated successfully!', 'success');
        }

        function generateDrillingGCode(machine, coords, depth, height, cycle, qValue) {
            const coordsText = coords.slice(1).map(c => `X${c.x} Y${c.y}`).join('\n');
            const qParam = cycle === 'G83' ? ` Q${parseFloat(qValue).toFixed(3)}` : '';
            const drillingCmd = `${cycle} X${coords[0].x} Y${coords[0].y}${qParam} R${parseFloat(height).toFixed(3)} Z${parseFloat(depth).toFixed(3)} F100.`;
            
            const templates = {
                takisawa: `% 
G91G28Z0 
G17G40G49G80
T4(K10)
G0G90G57X0Y0 
M15
G43H04Z30. 
G90G92X0Y0Z30. 
M3S3200 
G0 X${coords[0].x} Y${coords[0].y}
${drillingCmd}
${coordsText}
G80
G0 Z30.
X0Y0
M5 
M9 
G91G28Z0 
M14
G91G28Y0 
M30 
%`,
                robodrill: `% 
G91G28Z0 
G0G17G40G49G80G90
M6 T4( K10)
G0G90G54X0Y0 
G43H54Z30. 
G90G92X0Y0Z30. 
M3S2200
M7 
G0 X${coords[0].x} Y${coords[0].y}
${drillingCmd}
${coordsText}
G80
G0 Z30.
X0Y0
M5 
M9 
G91G28Z0 
G91G28X0Y0 
M30 
%`,
                f54: `%
G91G28Z0
G17G40G49G80
G0G90G54X0Y0
G43H01Z10.
G90G92Z10.
M3S24000
Z10.
G1Z${parseFloat(depth).toFixed(3)}F300.
G0 X${coords[0].x} Y${coords[0].y}
${drillingCmd}
${coordsText}
G80
G0Z10.
X0Y0
G91G28Z0
G0Y80.
M72
M00
M99
%`,
                mitsu: `%
G91 G28 Z0
T6 (K6 )
G90 G0 G54 X0 Y0
G43 H06 Z10.
G90 G92 Z10.
M3 S4000
M8
G0 X${coords[0].x} Y${coords[0].y}
${drillingCmd}
${coordsText}
G80
G0 Z10.
X0 Y0
G91 G28 Z0
M5
M9
M30 
%`
            };

            return templates[machine] || templates.robodrill;
        }

        function generateMillingGCode(machine, finishCoords, depth, feedRate, toolDiameter, roughCoords, millingType, leadInDistance) {
            const depthFormatted = parseFloat(depth).toFixed(3);
            
            // ROUGH PASS SECTION
            let roughSection = '';
            if (roughCoords && roughCoords.length > 0) {
                // Calculate approach point based on rough coords
                let roughApproach = '';
                if (millingType === 'outside') {
                    // Outside: approach from outside the rough path
                    const v1 = roughCoords[0];
                    const centerX = 0;
                    const centerY = 0;
                    const dx = parseFloat(v1.x) - centerX;
                    const dy = parseFloat(v1.y) - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const approachX = (parseFloat(v1.x) + (dx / distance) * leadInDistance).toFixed(3);
                    const approachY = (parseFloat(v1.y) + (dy / distance) * leadInDistance).toFixed(3);
                    
                    roughApproach = `G0 X${approachX} Y${approachY}
G0 Z5.
G1 Z${depthFormatted} F100.
G1 X${v1.x} Y${v1.y} F${feedRate}
`;
                } else {
                    // Inside: xu·ªëng Z t·∫°i t√¢m (0,0), ch·∫°y ra vertex 1
                    roughApproach = `G0 X0 Y0
G0 Z5.
G1 Z${depthFormatted} F100.
G1 X${roughCoords[0].x} Y${roughCoords[0].y} F${feedRate}
`;
                }
                
                // Build rough path
                let roughPathCoords;
                if (millingType === 'inside') {
                    // Inside: NG∆Ø·ª¢C chi·ªÅu (v1‚Üív6‚Üív5‚Üív4‚Üív3‚Üív2‚Üív1)
                    const reversedRough = [roughCoords[0], ...roughCoords.slice(1).reverse()];
                    roughPathCoords = [...reversedRough, reversedRough[0]];
                } else {
                    // Outside: THU·∫¨N chi·ªÅu (v1‚Üív2‚Üív3‚Üív4‚Üív5‚Üív6‚Üív1)
                    roughPathCoords = [...roughCoords, roughCoords[0]];
                }
                
                const roughPath = roughPathCoords.slice(1).map((c, i) => {
                    return `X${c.x} Y${c.y}`;
                }).join('\n');
                
                roughSection = `${roughApproach}${roughPath}

`;
            }
            
            // FINISH PASS SECTION
            let finishSection = '';
            let finishPathCoords;
            if (millingType === 'inside') {
                // Inside: NG∆Ø·ª¢C chi·ªÅu (v1‚Üív6‚Üív5‚Üív4‚Üív3‚Üív2‚Üív1)
                const reversedCoords = [finishCoords[0], ...finishCoords.slice(1).reverse()];
                finishPathCoords = [...reversedCoords, reversedCoords[0]];
            } else {
                // Outside: THU·∫¨N chi·ªÅu (v1‚Üív2‚Üív3‚Üív4‚Üív5‚Üív6‚Üív1)
                finishPathCoords = [...finishCoords, finishCoords[0]];
            }
            
            const finishPath = finishPathCoords.map((c, i) => {
                if (i === 0) {
                    return `G1 X${c.x} Y${c.y} F${feedRate}`;
                }
                return `X${c.x} Y${c.y}`;
            }).join('\n');
            
            if (roughCoords && roughCoords.length > 0) {
                finishSection = `${finishPath}
`;
            } else {
                // No rough pass, need approach for finish
                let finishApproach = '';
                if (millingType === 'outside') {
                    const v1 = finishCoords[0];
                    const centerX = 0;
                    const centerY = 0;
                    const dx = parseFloat(v1.x) - centerX;
                    const dy = parseFloat(v1.y) - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const approachX = (parseFloat(v1.x) + (dx / distance) * leadInDistance).toFixed(3);
                    const approachY = (parseFloat(v1.y) + (dy / distance) * leadInDistance).toFixed(3);
                    
                    finishApproach = `G0 X${approachX} Y${approachY}
G0 Z5.
G1 Z${depthFormatted} F100.
`;
                } else {
                    // Inside: xu·ªëng Z t·∫°i t√¢m (0,0), ch·∫°y ra v1
                    finishApproach = `G0 X0 Y0
G0 Z5.
G1 Z${depthFormatted} F100.
G1 X${finishCoords[0].x} Y${finishCoords[0].y} F${feedRate}
`;
                }
                finishSection = `${finishApproach}${finishSection}
`;
            }
            
            const toolInfo = `D${toolDiameter} MILL`;

            const templates = {
                takisawa: `%
G91G28Z0
G17G40G49G80
T1(${toolInfo})
G0G90G57X0Y0
M15
G43H01Z30.
G90G92X0Y0Z30.
M3S3000
M8
${roughSection}
${finishSection}
G0 Z30.
X0Y0
M5
M9
G91G28Z0
M14
G91G28Y0
M30
%`,
                robodrill: `%
G91G28Z0
G0G17G40G49G80G90
M6 T1(${toolInfo})
G0G90G54X0Y0
G43H54Z30.
G90G92X0Y0Z30.
M3S2500
M7
${roughSection}
${finishSection}
G0 Z30.
X0Y0
M5
M9
G91G28Z0
G91G28X0Y0
M30
%`,
                f54: `%
G91G28Z0
G17G40G49G80
G0G90G54X0Y0
G43H01Z10.
G90G92Z10.
M3S5000
M8
${roughSection}
${finishSection}
G0Z10.
X0Y0
G91G28Z0
G0Y80.
M72
M00
M99
%`,
                mitsu: `%
G91 G28 Z0
T1 (${toolInfo})
G90 G0 G54 X0 Y0
G43 H01 Z10.
G90 G92 Z10.
M3 S3500
M8
${roughSection}
${finishSection}
G0 Z10.
X0 Y0
G91 G28 Z0
M5
M9
M30
%`
            };

            return templates[machine] || templates.robodrill;
        }

        function drawDrillingVisualization(radius, coords) {
            const canvas = document.getElementById('visualCanvas');
            const container = canvas.parentElement;
            const ctx = canvas.getContext('2d');
            
            // Set canvas size based on container
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = Math.min(canvas.width, canvas.height) / (radius * 2.5);

            // Draw PCD circle
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * scale, 0, Math.PI * 2);
            ctx.stroke();

            // Draw center cross
            ctx.strokeStyle = '#8892a6';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(centerX - 20, centerY);
            ctx.lineTo(centerX + 20, centerY);
            ctx.moveTo(centerX, centerY - 20);
            ctx.lineTo(centerX, centerY + 20);
            ctx.stroke();

            // Draw holes
            coords.forEach((coord, idx) => {
                const x = centerX + parseFloat(coord.x) * scale;
                const y = centerY - parseFloat(coord.y) * scale;

                // Hole circle
                ctx.fillStyle = '#0088ff';
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.fill();

                // Hole number
                ctx.fillStyle = '#e0e6f0';
                ctx.font = 'bold 16px Orbitron';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(idx + 1, x, y);

                // Line from center
                ctx.strokeStyle = 'rgba(0, 136, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
            });
        }

        function drawMillingVisualization(toolPathCoords, targetCoords, roughCoords) {
            const canvas = document.getElementById('visualCanvas');
            const container = canvas.parentElement;
            const ctx = canvas.getContext('2d');
            
            // Set canvas size based on container
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Find max dimension for scaling (include all paths)
            const allCoords = [...toolPathCoords, ...targetCoords];
            if (roughCoords) allCoords.push(...roughCoords);
            const maxDim = Math.max(
                ...allCoords.map(c => Math.abs(parseFloat(c.x))),
                ...allCoords.map(c => Math.abs(parseFloat(c.y)))
            );
            const scale = Math.min(canvas.width, canvas.height) / (maxDim * 2.5);

            // Draw center cross
            ctx.strokeStyle = '#8892a6';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(centerX - 20, centerY);
            ctx.lineTo(centerX + 20, centerY);
            ctx.moveTo(centerX, centerY - 20);
            ctx.lineTo(centerX, centerY + 20);
            ctx.stroke();

            // Draw TARGET hexagon (green - the actual shape we want)
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            targetCoords.forEach((coord, idx) => {
                const x = centerX + parseFloat(coord.x) * scale;
                const y = centerY - parseFloat(coord.y) * scale;
                
                if (idx === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();

            // Draw TOOL PATH (red - where the tool center travels)
            ctx.strokeStyle = '#ff3366';
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            
            toolPathCoords.forEach((coord, idx) => {
                const x = centerX + parseFloat(coord.x) * scale;
                const y = centerY - parseFloat(coord.y) * scale;
                
                if (idx === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw ROUGH PATH (orange dashed - with finish allowance)
            if (roughCoords && roughCoords.length > 0) {
                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                
                roughCoords.forEach((coord, idx) => {
                    const x = centerX + parseFloat(coord.x) * scale;
                    const y = centerY - parseFloat(coord.y) * scale;
                    
                    if (idx === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.closePath();
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Draw vertices on TOOL PATH (blue dots with numbers only - no coordinates)
            toolPathCoords.forEach((coord, idx) => {
                const x = centerX + parseFloat(coord.x) * scale;
                const y = centerY - parseFloat(coord.y) * scale;

                // Vertex circle
                ctx.fillStyle = '#0088ff';
                ctx.beginPath();
                ctx.arc(x, y, 10, 0, Math.PI * 2);
                ctx.fill();

                // Vertex number only (no coordinates)
                ctx.fillStyle = '#e0e6f0';
                ctx.font = 'bold 16px Orbitron';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(idx + 1, x, y);
            });

            // Add legend
            ctx.font = '14px Roboto Mono';
            ctx.textAlign = 'left';
            
            // Target shape legend (green solid)
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(20, 22);
            ctx.lineTo(50, 22);
            ctx.stroke();
            ctx.fillStyle = '#e0e6f0';
            ctx.fillText('Target Shape', 60, 25);
            
            // Tool path legend (red dashed)
            ctx.strokeStyle = '#ff3366';
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(20, 47);
            ctx.lineTo(50, 47);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#e0e6f0';
            ctx.fillText('Tool Path', 60, 50);
            
            // Rough path legend (orange dashed)
            if (roughCoords && roughCoords.length > 0) {
                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(20, 72);
                ctx.lineTo(50, 72);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = '#e0e6f0';
                ctx.fillText('Rough Path', 60, 75);
            }
            
            // Machining type text
            ctx.fillStyle = '#ffaa00';
            ctx.font = 'bold 14px Orbitron';
            const typeTextY = roughCoords && roughCoords.length > 0 ? 100 : 75;
            ctx.fillText(selectedMillingType === 'inside' ? 'INSIDE CUT' : 'OUTSIDE CUT', 20, typeTextY);
        }

        function calculateCircular() {
            const centerX = parseFloat(document.getElementById('centerX').value);
            const centerY = parseFloat(document.getElementById('centerY').value);
            const pcd = parseFloat(document.getElementById('circularPCD').value);
            const toolDia = parseFloat(document.getElementById('toolDiameterCirc').value);
            const depth = parseFloat(document.getElementById('circularDepth').value);
            const finishAllow = parseFloat(document.getElementById('finishAllowance').value);

            if (isNaN(centerX) || isNaN(centerY) || isNaN(pcd) || isNaN(toolDia) || isNaN(depth) || isNaN(finishAllow)) {
                showStatus('Please enter all parameters!', 'error');
                return;
            }

            // Calculate coordinates
            let E2, D2, D6, E6, D7, E7, startX;
            const arcCommand = selectedCircularType === 'inside' ? 'G03' : 'G02';

            if (selectedCircularType === 'inside') {
                E2 = (pcd - toolDia) / 2;
                D2 = E2 - (finishAllow / 2);
                D6 = centerX - ((pcd - toolDia - finishAllow) / 2);
                E6 = centerX - ((pcd - toolDia) / 2);
                D7 = centerX + ((pcd - toolDia - finishAllow) / 2);
                E7 = centerX + ((pcd - toolDia) / 2);
                startX = centerX;
            } else {
                E2 = (pcd + toolDia) / 2;
                D2 = E2 + (finishAllow / 2);
                D6 = centerX - ((pcd + toolDia + finishAllow) / 2);
                E6 = centerX - ((pcd + toolDia) / 2);
                D7 = centerX + ((pcd + toolDia + finishAllow) / 2);
                E7 = centerX + ((pcd + toolDia) / 2);
                startX = D7;
            }

            currentGCode = `G0 X${startX.toFixed(3)} Y${centerY.toFixed(3)}
Z2.
G1 Z${depth.toFixed(3)} F100.
X${D7.toFixed(3)} F300.
${arcCommand} X${D6.toFixed(3)} R${D2.toFixed(3)}
${arcCommand} X${D7.toFixed(3)} R${D2.toFixed(3)}

G1 X${E7.toFixed(3)}
${arcCommand} X${E6.toFixed(3)} R${E2.toFixed(3)}
${arcCommand} X${E7.toFixed(3)} R${E2.toFixed(3)}`;

            document.getElementById('gcodeOutput').textContent = currentGCode;
            drawCircularVisualization(centerX, centerY, pcd, selectedCircularType);
            showStatus('G-Code generated successfully!', 'success');
        }

        function drawCircularVisualization(cx, cy, pcd, cutType) {
            const canvas = document.getElementById('visualCanvas');
            const container = canvas.parentElement;
            const ctx = canvas.getContext('2d');
            
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = Math.min(canvas.width, canvas.height) / (pcd * 1.05);

            // Draw center cross
            ctx.strokeStyle = '#8892a6';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(centerX - 20, centerY);
            ctx.lineTo(centerX + 20, centerY);
            ctx.moveTo(centerX, centerY - 20);
            ctx.lineTo(centerX, centerY + 20);
            ctx.stroke();

            // Draw PCD circle
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, (pcd / 2) * scale, 0, Math.PI * 2);
            ctx.stroke();

            // Draw tool paths with FIXED offset
            const pcdRadius = (pcd / 2) * scale;
            const visualOffset = 15;
            
            if (cutType === 'inside') {
                ctx.strokeStyle = '#ff3366';
                ctx.lineWidth = 3;
                ctx.setLineDash([8, 4]);
                ctx.beginPath();
                ctx.arc(centerX, centerY, pcdRadius - visualOffset, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(centerX, centerY, pcdRadius - visualOffset * 2, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            } else {
                ctx.strokeStyle = '#ff3366';
                ctx.lineWidth = 3;
                ctx.setLineDash([8, 4]);
                ctx.beginPath();
                ctx.arc(centerX, centerY, pcdRadius + visualOffset, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(centerX, centerY, pcdRadius + visualOffset * 2, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Draw center point
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Center coordinates
            ctx.fillStyle = '#00ff88';
            ctx.font = 'bold 13px Roboto Mono';
            ctx.textAlign = 'center';
            ctx.fillText(`(${cx.toFixed(3)}, ${cy.toFixed(3)})`, centerX, centerY - 20);

            // Calculate E6, E7 from G-code
            const radius = cutType === 'inside' ? (pcd - parseFloat(document.getElementById('toolDiameterCirc').value)) / 2 : (pcd + parseFloat(document.getElementById('toolDiameterCirc').value)) / 2;
            const E6 = cx - radius;
            const E7 = cx + radius;
            
            const leftX = centerX - pcdRadius;
            const rightX = centerX + pcdRadius;
            
            // Left point
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            ctx.arc(leftX, centerY, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#e0e6f0';
            ctx.font = 'bold 16px Orbitron';
            ctx.textAlign = 'center';
            ctx.fillText('1', leftX, centerY);
            ctx.fillStyle = '#00ff88';
            ctx.font = 'bold 13px Roboto Mono';
            ctx.textAlign = 'right';
            ctx.fillText(`(${E6.toFixed(3)}, ${cy.toFixed(3)})`, leftX - 50, centerY);
            
            // Right point
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            ctx.arc(rightX, centerY, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#e0e6f0';
            ctx.font = 'bold 16px Orbitron';
            ctx.textAlign = 'center';
            ctx.fillText('2', rightX, centerY);
            ctx.fillStyle = '#00ff88';
            ctx.font = 'bold 13px Roboto Mono';
            ctx.textAlign = 'left';
            ctx.fillText(`(${E7.toFixed(3)}, ${cy.toFixed(3)})`, rightX + 50, centerY);

            // Legend
            ctx.font = '14px Roboto Mono';
            ctx.textAlign = 'left';
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(20, 22);
            ctx.lineTo(50, 22);
            ctx.stroke();
            ctx.fillStyle = '#e0e6f0';
            ctx.fillText('PCD Circle', 60, 25);
            
            ctx.strokeStyle = '#ff3366';
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(20, 47);
            ctx.lineTo(50, 47);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#e0e6f0';
            ctx.fillText('Finish Path', 60, 50);
            
            ctx.strokeStyle = '#ffaa00';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(20, 72);
            ctx.lineTo(50, 72);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#e0e6f0';
            ctx.fillText('Rough Path', 60, 75);
            
            ctx.fillStyle = '#ffaa00';
            ctx.font = 'bold 14px Orbitron';
            ctx.fillText(cutType === 'inside' ? 'INSIDE CUT' : 'OUTSIDE CUT', 20, 100);
        }

        function copyGCode() {
            if (!currentGCode) {
                showStatus('No G-Code to copy!', 'error');
                return;
            }

            navigator.clipboard.writeText(currentGCode).then(() => {
                showStatus('G-Code copied to clipboard!', 'success');
            }).catch(() => {
                showStatus('Copy error!', 'error');
            });
        }

        function downloadTAP() {
            if (!currentGCode) {
                showStatus('No G-Code to download!', 'error');
                return;
            }

            let filename;
            if (selectedMode === 'drilling') {
                const pcd = document.getElementById('pcd').value;
                const holes = document.getElementById('holes').value;
                filename = `pcd_drilling_${pcd}_holes_${holes}_${selectedMachine}.tap`;
            } else {
                const H = document.getElementById('hexHeight').value;
                const type = selectedMillingType === 'inside' ? 'inside' : 'outside';
                filename = `hexagon_milling_H${H}_${type}_${selectedMachine}.tap`;
            }

            const blob = new Blob([currentGCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            showStatus(`File ${filename} downloaded!`, 'success');
        }

        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status-message ${type}`;
            setTimeout(() => {
                status.className = 'status-message';
            }, 3000);
        }

        // Sync PCD and Radius for circular mode
        let isUpdatingCircularPCD = false;
        let isUpdatingCircularRadius = false;

        document.getElementById('circularPCD').addEventListener('input', function() {
            if (!isUpdatingCircularRadius) {
                isUpdatingCircularPCD = true;
                const pcd = parseFloat(this.value) || 0;
                document.getElementById('circularRadius').value = (pcd / 2).toFixed(3);
                isUpdatingCircularPCD = false;
            }
        });

        document.getElementById('circularRadius').addEventListener('input', function() {
            if (!isUpdatingCircularPCD) {
                isUpdatingCircularRadius = true;
                const radius = parseFloat(this.value) || 0;
                document.getElementById('circularPCD').value = (radius * 2).toFixed(3);
                isUpdatingCircularRadius = false;
            }
        });

        // ========== G-CODE CHECKER FUNCTIONS - ADDED ==========
        
        // Update line numbers
        function updateLineNumbers() {
            const textarea = document.getElementById('checkerTextarea');
            const lineNumbers = document.getElementById('lineNumbers');
            
            // If empty or only placeholder, show line 1
            if (!textarea.value || textarea.value.trim() === '') {
                lineNumbers.textContent = '1';
                return;
            }
            
            const lines = textarea.value.split('\n');
            const lineCount = lines.length;
            
            let numbers = '';
            for (let i = 1; i <= lineCount; i++) {
                numbers += i + (i < lineCount ? '\n' : '');
            }
            lineNumbers.textContent = numbers;
        }

        // Sync scroll between textarea and line numbers
        document.getElementById('checkerTextarea').addEventListener('scroll', function() {
            document.getElementById('lineNumbers').scrollTop = this.scrollTop;
        });

        // Update line numbers on input
        document.getElementById('checkerTextarea').addEventListener('input', updateLineNumbers);

        // Update line numbers on paste
        document.getElementById('checkerTextarea').addEventListener('paste', function() {
            setTimeout(updateLineNumbers, 10);
        });
        
        // File upload handler
        document.getElementById('checkerFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('checkerFilename').textContent = 'üìÑ Loading: ' + file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('checkerTextarea').value = e.target.result;
                    document.getElementById('checkerFilename').textContent = '‚úÖ Loaded: ' + file.name;
                    updateLineNumbers(); // Update line numbers after loading
                };
                reader.readAsText(file);
            }
        });

        function checkGCodeFunc() {
            const input = document.getElementById('checkerTextarea').value;
            if (!input.trim()) {
                showCheckerMessage('‚ö†Ô∏è No G-Code to check!', 'error');
                return;
            }

            const lines = input.split('\n');
            const errors = [];
            
            const coordinateParams = ['X', 'Y', 'Z', 'I', 'J', 'K'];
            const otherParams = ['F', 'R', 'P', 'Q'];
            
            lines.forEach((line, index) => {
                const lineNumber = index + 1;
                const trimmedLine = line.trim();
                
                if (!trimmedLine || trimmedLine.startsWith('(') || trimmedLine.startsWith('%') || trimmedLine === '.......') {
                    return;
                }
                
                // Check coordinate parameters
                coordinateParams.forEach(param => {
                    const regex = new RegExp(`${param}(-?\\d+)(?![\\d.])`, 'gi');
                    let match;
                    
                    while ((match = regex.exec(trimmedLine)) !== null) {
                        const fullMatch = match[0];
                        const number = match[1];
                        
                        if (!number.includes('.') && parseInt(number) !== 0) {
                            errors.push({
                                line: lineNumber,
                                code: trimmedLine,
                                message: `Missing decimal at "${fullMatch}" ‚Üí Should be "${param}${number}."`
                            });
                        }
                    }
                });
                
                // Check other parameters
                otherParams.forEach(param => {
                    const regex = new RegExp(`${param}(-?\\d+)(?![\\d.])`, 'gi');
                    let match;
                    
                    while ((match = regex.exec(trimmedLine)) !== null) {
                        const fullMatch = match[0];
                        const number = match[1];
                        
                        if (!number.includes('.')) {
                            errors.push({
                                line: lineNumber,
                                code: trimmedLine,
                                message: `Missing decimal at "${fullMatch}" ‚Üí Should be "${param}${number}."`
                            });
                        }
                    }
                });
            });
            
            displayCheckerResults(lines.length, errors);
        }

        function displayCheckerResults(totalLines, errors) {
            const resultDiv = document.getElementById('checkerResult');
            const errorCount = errors.length;
            
            document.getElementById('checkerTotalLines').textContent = totalLines;
            document.getElementById('checkerErrorCount').textContent = errorCount;
            const successRate = totalLines > 0 ? Math.round(((totalLines - errorCount) / totalLines) * 100) : 100;
            document.getElementById('checkerSuccessRate').textContent = successRate + '%';
            
            if (errorCount === 0) {
                resultDiv.innerHTML = `
                    <div class="checker-success">
                        <div style="font-size: 3rem; margin-bottom: 10px;">‚úÖ</div>
                        <div style="font-size: 1.2rem;">PERFECT!</div>
                        <div style="font-size: 0.9rem; font-weight: 400; margin-top: 5px;">No errors found</div>
                    </div>
                `;
            } else {
                let html = `<div style="color: var(--error); font-weight: bold; margin-bottom: 15px;">
                    ‚ö†Ô∏è Found ${errorCount} error${errorCount > 1 ? 's' : ''}:
                </div>`;
                
                errors.forEach(error => {
                    html += `
                        <div class="checker-error-item" onclick="jumpToLine(${error.line})" style="cursor: pointer; transition: all 0.2s;">
                            <div class="checker-error-line">Line ${error.line} <span style="font-size: 0.7rem; color: var(--text-secondary);">(click to jump)</span></div>
                            <div class="checker-error-code">${escapeHTML(error.code)}</div>
                            <div class="checker-error-msg">‚ùå ${error.message}</div>
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;
                
                // Debug: Log first error to console
                if (errors.length > 0) {
                    console.log('First error:', errors[0]);
                    console.log('Total lines in textarea:', document.getElementById('checkerTextarea').value.split('\n').length);
                }
            }
            
            resultDiv.scrollTop = 0;
        }

        // Function to jump to specific line in textarea
        function jumpToLine(lineNumber) {
            const textarea = document.getElementById('checkerTextarea');
            const content = textarea.value;
            
            if (!content) return;
            
            const lines = content.split('\n');
            
            // Validate line number
            if (lineNumber < 1 || lineNumber > lines.length) {
                console.error('Invalid line number:', lineNumber);
                return;
            }
            
            // Calculate exact character position
            let charPosition = 0;
            for (let i = 0; i < lineNumber - 1; i++) {
                charPosition += lines[i].length + 1; // +1 for \n
            }
            
            const lineStart = charPosition;
            const lineEnd = charPosition + lines[lineNumber - 1].length;
            
            // Clear focus first
            textarea.blur();
            
            // Set focus and selection
            setTimeout(() => {
                textarea.focus();
                
                // Move cursor to line start first (this triggers scroll)
                textarea.setSelectionRange(lineStart, lineStart);
                textarea.scrollTop; // Force reflow
                
                // Then select the full line
                setTimeout(() => {
                    textarea.setSelectionRange(lineStart, lineEnd);
                    
                    // Calculate scroll position to center the line
                    const textareaRect = textarea.getBoundingClientRect();
                    const lineHeight = parseFloat(getComputedStyle(textarea).lineHeight) || 16;
                    const linesVisible = Math.floor(textareaRect.height / lineHeight);
                    
                    // Scroll so line appears in upper third of visible area
                    const targetLine = Math.max(0, lineNumber - Math.floor(linesVisible / 3));
                    textarea.scrollTop = targetLine * lineHeight;
                    
                    // Visual highlight
                    textarea.style.transition = 'background-color 0.3s ease';
                    textarea.style.backgroundColor = 'rgba(255, 170, 0, 0.2)';
                    
                    setTimeout(() => {
                        textarea.style.backgroundColor = 'var(--bg-dark)';
                        setTimeout(() => {
                            textarea.style.transition = '';
                        }, 300);
                    }, 600);
                }, 50);
            }, 50);
        }

        function fixGCodeFunc() {
            const input = document.getElementById('checkerTextarea').value;
            if (!input.trim()) {
                showCheckerMessage('‚ö†Ô∏è No G-Code to fix!', 'error');
                return;
            }

            const lines = input.split('\n');
            let fixedLines = [];
            let fixCount = 0;
            
            const coordinateParams = ['X', 'Y', 'Z', 'I', 'J', 'K'];
            const otherParams = ['F', 'R', 'P', 'Q'];
            
            lines.forEach((line) => {
                let fixedLine = line;
                const trimmedLine = line.trim();
                
                if (!trimmedLine || trimmedLine.startsWith('(') || trimmedLine.startsWith('%') || trimmedLine === '.......') {
                    fixedLines.push(line);
                    return;
                }
                
                coordinateParams.forEach(param => {
                    const regex = new RegExp(`${param}(-?\\d+)(?![\\d.])`, 'gi');
                    fixedLine = fixedLine.replace(regex, (match, number) => {
                        if (!number.includes('.') && parseInt(number) !== 0) {
                            fixCount++;
                            return `${param}${number}.`;
                        }
                        return match;
                    });
                });
                
                otherParams.forEach(param => {
                    const regex = new RegExp(`${param}(-?\\d+)(?![\\d.])`, 'gi');
                    fixedLine = fixedLine.replace(regex, (match, number) => {
                        if (!number.includes('.')) {
                            fixCount++;
                            return `${param}${number}.`;
                        }
                        return match;
                    });
                });
                
                fixedLines.push(fixedLine);
            });
            
            document.getElementById('checkerTextarea').value = fixedLines.join('\n');
            updateLineNumbers(); // Update line numbers after fixing
            
            const resultDiv = document.getElementById('checkerResult');
            if (fixCount > 0) {
                resultDiv.innerHTML = `
                    <div style="background: rgba(255, 170, 0, 0.1); border-left: 3px solid var(--warning); padding: 20px; border-radius: 8px;">
                        <div style="color: var(--warning); font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;">
                            üîß Auto-Fixed ${fixCount} Error${fixCount > 1 ? 's' : ''}!
                        </div>
                        <div style="color: var(--text-primary);">
                            ‚úÖ Code corrected on the left
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">
                            üí° Click CHECK to verify or SAVE to download
                        </div>
                    </div>
                `;
                // Removed auto-check - user must click CHECK button manually
            } else {
                showCheckerMessage('‚úÖ No errors to fix!', 'success');
            }
        }

        function saveGCodeFunc() {
            const content = document.getElementById('checkerTextarea').value;
            
            if (!content.trim()) {
                showCheckerMessage('‚ö†Ô∏è No G-Code to save!', 'error');
                return;
            }
            
            const filenameDisplay = document.getElementById('checkerFilename').textContent;
            let fileName = 'gcode_checked.tap';
            
            if (filenameDisplay.includes('Loaded:')) {
                const originalName = filenameDisplay.replace('‚úÖ Loaded: ', '').trim();
                const nameParts = originalName.split('.');
                const extension = nameParts.length > 1 ? nameParts.pop() : 'tap';
                const baseName = nameParts.join('.');
                fileName = `${baseName}_checked.${extension}`;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const resultDiv = document.getElementById('checkerResult');
            resultDiv.innerHTML = `
                <div style="background: rgba(0, 255, 136, 0.1); border-left: 3px solid var(--primary); padding: 20px; border-radius: 8px;">
                    <div style="color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;">
                        üíæ File Saved Successfully!
                    </div>
                    <div style="color: var(--text-primary); margin-bottom: 8px;">
                        üìÅ Filename: <strong style="color: var(--primary);">${fileName}</strong>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.5;">
                        üìÇ Location: Downloads folder<br>
                        üí° Recommended: Move to <code style="color: var(--warning); background: var(--bg-darker); padding: 2px 6px; border-radius: 3px;">G:\\test\\</code>
                    </div>
                </div>
            `;
        }

        function clearCheckerFunc() {
            document.getElementById('checkerTextarea').value = '';
            document.getElementById('checkerFileInput').value = '';
            document.getElementById('checkerFilename').textContent = '';
            document.getElementById('lineNumbers').textContent = '1';
            document.getElementById('checkerResult').innerHTML = `
                <div style="text-align: center; color: var(--text-secondary); margin-top: 100px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">‚öôÔ∏è</div>
                    <div>Load G-Code file or paste code,</div>
                    <div>then click CHECK to analyze</div>
                </div>
            `;
            document.getElementById('checkerTotalLines').textContent = '0';
            document.getElementById('checkerErrorCount').textContent = '0';
            document.getElementById('checkerSuccessRate').textContent = '100%';
        }

        function showCheckerMessage(message, type) {
            const resultDiv = document.getElementById('checkerResult');
            const bgColor = type === 'error' ? 'rgba(255, 51, 102, 0.1)' : 'rgba(0, 255, 136, 0.1)';
            const borderColor = type === 'error' ? 'var(--error)' : 'var(--primary)';
            const textColor = type === 'error' ? 'var(--error)' : 'var(--primary)';
            
            resultDiv.innerHTML = `
                <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: ${textColor}; font-weight: bold;">${message}</div>
                </div>
            `;
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-calculate on load
        window.addEventListener('load', calculate);
    </script>
</body>
</html>
